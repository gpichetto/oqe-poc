<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title
          th:text="${jobTicket.answers?.title != null} ? ${jobTicket.answers.title} : 'Job Ticket Report'"
  ></title>
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
  />
  <style>
    /* Page Number Styling for PDF */
    @page {
      @bottom-center {
        content: "Page " counter(page) " of " counter(pages);
        font-size: 10px;
        color: #6c757d;
        font-family: Arial, sans-serif;
      }
    }

    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-gray: #f8f9fa;
      --dark-gray: #6c757d;
      --border-color: #dee2e6;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: var(--light-gray);
    }

    .header {
      background-color: #1a5276 !important; /* Darker blue */
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }

    .ticket-info {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .section-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      overflow: hidden;
      page-break-inside: avoid;
      border: 1px solid var(--border-color);
    }

    .section-header {
      background-color: var(--secondary-color);
      color: white;
      padding: 1rem 1.5rem;
      margin: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header .icon {
      margin-right: 0.5rem;
    }

    .section-description {
      background-color: #ecf0f1;
      padding: 0.75rem 1.5rem;
      font-style: italic;
      border-bottom: 1px solid var(--border-color);
    }

    .section-body {
      padding: 1.5rem;
    }

    /* Question Styling */
    .question {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1rem;
    }

    .question:last-child {
      margin-bottom: 0;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .question-text {
      font-weight: 500;
      margin: 0;
      color: var(--primary-color);
      flex: 1;
    }

    .question-type {
      font-size: 0.8em;
      color: var(--dark-gray);
      background-color: #e9ecef;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      margin-left: 0.5rem;
    }

    .mandatory {
      color: var(--accent-color);
      font-weight: bold;
      margin-left: 0.5rem;
    }

    .response {
      color: #555;
      margin-top: 0.5rem;
      background-color: #f8f9fa;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 4px;
      border-left: 4px solid var(--primary-color);
    }

    /* Section title styling */
    .section-header {
      background-color: #2c7cb8 !important; /* Darker blue */
      color: white !important;
      padding: 0.75rem 1.25rem !important;
      margin: 1.5rem 0 0 0 !important;
      border-radius: 4px 4px 0 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section-header h4 {
      color: white !important;
      font-weight: 600 !important;
      margin: 0 !important;
      padding: 0 !important;
      font-size: 1.25rem !important;
      line-height: 1.4 !important;
      letter-spacing: 0.3px;
    }

    .section-description {
      color: #2c3e50 !important; /* Darker text for better contrast */
      background-color: #e6f2ff !important; /* Light blue background */
      margin: 0 !important;
      padding: 0.75rem 1.25rem !important;
      font-size: 0.95rem;
      border-radius: 0 0 4px 4px;
      border-top: none;
    }

    .signature-image {
      max-width: 250px;
      max-height: 100px;
      margin-top: 0.5rem;
      border: 1px solid var(--border-color);
      padding: 0.25rem;
      background-color: white;
    }

    .choice {
      display: inline-block;
      margin: 0.2rem 0.5rem 0.2rem 0;
      padding: 0.3rem 0.8rem;
      background-color: var(--secondary-color);
      color: white;
      border-radius: 15px;
      font-size: 0.85em;
    }

    .selected-choice {
      background-color: #a0d8ef;
      font-weight: 500;
    }

    .comment-box {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .metadata {
      font-size: 0.85em;
      color: var(--dark-gray);
      margin-bottom: 0.5rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .info-item {
      padding: 1rem;
      background-color: var(--light-gray);
      border-radius: 6px;
      border-left: 3px solid var(--secondary-color);
    }

    .info-label {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.8em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.3rem;
    }

    .info-value {
      color: #555;
      word-break: break-word;
    }
    
    /* New consistent info boxes */
    .info-box {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      height: 100%;
    }

    .info-box h5 {
      color: #2c3e50;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: none;
    }

    .info-item {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .info-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .info-item strong {
      color: #2c3e50;
      font-weight: 500;
      margin-right: 0.5rem;
    }

    .info-item .text-muted {
      color: #6c757d !important;
    }
    
    @media print {
      .info-box {
        box-shadow: none;
        border: 1px solid #dee2e6;
        page-break-inside: avoid;
      }
    }

    .footer {
      text-align: center;
      padding: 1.5rem 0;
      color: var(--dark-gray);
      font-size: 0.85em;
      border-top: 1px solid var(--border-color);
      margin-top: 2rem;
    }

    .badge {
      font-weight: 500;
      padding: 0.35em 0.65em;
    }

    .validation-message {
      color: #dc3545;
      font-size: 0.85em;
      margin-top: 0.25rem;
      font-style: italic;
    }

    .question-metadata {
      font-size: 0.8em;
      color: var(--dark-gray);
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed #dee2e6;
    }

    @media print {
      .no-print {
        display: none !important;
      }

      body {
        background-color: white;
        padding: 0;
        font-size: 12px;
      }

      .container {
        max-width: 100%;
        padding: 0 15px;
      }

      .section-card {
        box-shadow: none;
        border: 1px solid var(--border-color);
        page-break-inside: avoid;
        break-inside: avoid;
      }

      .header {
        padding: 1rem 0;
        margin-bottom: 1rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      .ticket-info {
        padding: 1rem;
        margin-bottom: 1rem;
      }
    }

    /* Print-specific styles */
    @page {
      size: A4;
      margin: 1.5cm 1.5cm 2.5cm 1.5cm; /* Added bottom margin for footer */

      @bottom-center {
        content: counter(page) " / " counter(pages);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 0.8rem;
        color: #666;
        text-align: center;
        width: 100%;
      }
    }

    /* Ensure page breaks don't split important elements */
    .section-card,
    .ticket-info {
      page-break-inside: avoid;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="text-center mb-3">
    <img
            th:if="${logoUrl}"
            th:src="${logoUrl}"
            alt="Company Logo"
            class="img-fluid"
            style="max-height: 80px"
    />
  </div>
  <div
          class="header"
          style="
          background-color: #1a5276 !important;
          color: white !important;
          padding: 1.5rem 0;
          margin-bottom: 2rem;
        "
  >
    <div
            style="
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 1rem;
          "
    >
      <div style="padding-left: 1rem">
        <h1
                style="color: white !important; margin: 0 0 0.5rem 0"
                th:if="${jobTicket.answers?.title != null}"
                th:text="${jobTicket.answers.title}"
        >
          Job Ticket Report
        </h1>
      </div>
      <div
              style="
              background: rgba(255, 255, 255, 0.1);
              padding: 0.5rem 1rem;
              border-radius: 4px;
              margin-right: 1rem;
            "
      >
        <div style="font-size: 0.9rem">
          <strong>Checklist ID:</strong>
          <span th:text="${jobTicket.id}" style="margin-left: 0.5rem"
          >N/A</span
          >
        </div>
        <div style="font-size: 0.9rem">
          <strong>Work Order Number:</strong>
          <span th:if="${jobTicket?.answers?.metadata?.additional?.workOrder?.workOrderNum != null}"
                th:text="${jobTicket.answers.metadata.additional.workOrder.workOrderNum}"
                style="margin-left: 0.5rem">
              </span>
          <span th:if="${jobTicket?.answers?.metadata?.additional?.workOrder?.workOrderNum == null}"
                style="margin-left: 0.5rem; color: #999;">
                N/A
              </span>
        </div>
        <div style="font-size: 0.9rem">
          <strong>Work Order Title:</strong>
          <span th:if="${jobTicket?.answers?.metadata?.additional?.workOrder?.title != null}"
                th:text="${jobTicket.answers.metadata.additional.workOrder.title}"
                style="margin-left: 0.5rem">
              </span>
          <span th:if="${jobTicket?.answers?.metadata?.additional?.workOrder?.title == null}"
                style="margin-left: 0.5rem; color: #999;">
                N/A
              </span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row g-4">
    <!-- Report Info -->
    <div class="col-md-6">
      <div class="info-box">
        <h5>Report Information</h5>
        <div class="info-content">
          <div class="info-item" th:if="${jobTicket.createdAt}">
            <strong>Date and Time:</strong>
            <span th:text="${#temporals.format(jobTicket.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
          </div>
          <div class="info-item" th:if="${jobTicket.user?.email}">
            <strong>Author:</strong>
            <span class="text-muted" th:text="${jobTicket.user.email}"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Equipment -->
    <div class="col-md-6">
      <div class="info-box">
        <h5>Equipment</h5>
        <div class="info-content">
          <div class="info-item" th:if="${jobTicket.answers?.metadata?.additional?.asset?.designation}">
            <strong>Designation:</strong>
            <span th:text="${jobTicket.answers.metadata.additional.asset.designation}"></span>
          </div>
          <div class="info-item">
            <strong>Part Number:</strong>
            <span th:if="${jobTicket.answers?.metadata?.additional?.asset?.partNumber != null and jobTicket.answers.metadata.additional.asset.partNumber != ''}"
                  th:text="${jobTicket.answers.metadata.additional.asset.partNumber}">-</span>
            <span th:if="${jobTicket.answers?.metadata?.additional?.asset?.partNumber == null or jobTicket.answers.metadata.additional.asset.partNumber == ''}">-</span>
          </div>
          <div class="info-item">
            <strong>Serial Number:</strong>
            <span th:if="${jobTicket.answers?.metadata?.additional?.asset?.serialNumber != null and jobTicket.answers.metadata.additional.asset.serialNumber != ''}"
                  th:text="${jobTicket.answers.metadata.additional.asset.serialNumber}">-</span>
            <span th:if="${jobTicket.answers?.metadata?.additional?.asset?.serialNumber == null or jobTicket.answers.metadata.additional.asset.serialNumber == ''}">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Work Order Section -->
<div th:if="${workOrderForReport != null}" class="container mt-4">
  <div class="row g-4">
    <div class="col-12">
      <div class="info-box">
        <h5>Work Order Information</h5>
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                <div class="info-item">
                    <strong>Maximo Work Order Number:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.wonum} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>Description:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.description} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>Work Details:</strong>
                    <div class="text-muted" style="white-space: pre-line;" th:text="${workOrderForReport.longDescription} ?: '-'"></div>
                </div>
                
                <div class="info-item">
                    <strong>Maximo Equipment Number:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.assetNum} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>Work Type:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.workType} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>Vendor:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.vendor} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>Scheduled Start:</strong>
                    <span class="text-muted" 
                          th:if="${workOrderForReport.scheduledStart != null}" 
                          th:text="${#temporals.format(workOrderForReport.scheduledStart, 'yyyy-MM-dd HH:mm')}">-</span>
                    <span class="text-muted" th:unless="${workOrderForReport.scheduledStart != null}">-</span>
                </div>
                
                <div class="info-item">
                    <strong>Scheduled Finish:</strong>
                    <span class="text-muted" 
                          th:if="${workOrderForReport.scheduledFinish != null}" 
                          th:text="${#temporals.format(workOrderForReport.scheduledFinish, 'yyyy-MM-dd HH:mm')}">-</span>
                    <span class="text-muted" th:unless="${workOrderForReport.scheduledFinish != null}">-</span>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="col-md-6">
                <div class="info-item">
                    <strong>DRMIS Notification:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.n1n9} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>DRMIS ND:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.and} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>DRMIS Required Start:</strong>
                    <span class="text-muted" 
                          th:if="${workOrderForReport.callDate != null}" 
                          th:text="${#temporals.format(workOrderForReport.callDate, 'yyyy-MM-dd HH:mm')}">-</span>
                    <span class="text-muted" th:unless="${workOrderForReport.callDate != null}">-</span>
                </div>
                
                <div class="info-item">
                    <strong>CFTO:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.cfto} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>DRMIS Description:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.additionalDescription} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>DRMIS Maintenance Plan:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.amountCompletedPlan} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>NSC?:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.answerComplete} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>DRMIS Notification Date:</strong>
                    <span class="text-muted" 
                          th:if="${workOrderForReport.answerDate != null}" 
                          th:text="${#temporals.format(workOrderForReport.answerDate, 'yyyy-MM-dd HH:mm')}">-</span>
                    <span class="text-muted" th:unless="${workOrderForReport.answerDate != null}">-</span>
                </div>
                
                <div class="info-item">
                    <strong>DRMIS Notification From:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.answerFrom} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>DRMIS Notification To:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.answerTo} ?: '-'"></span>
                </div>
                
                <div class="info-item">
                    <strong>FER OPDEF Number:</strong>
                    <span class="text-muted" th:text="${workOrderForReport.operationDefinition} ?: '-'"></span>
                </div>
            </div>
        </div>
    </div>
    </div>
  </div>  
</div>


<!-- Main Content Sections -->
<div
        th:if="${jobTicket.answers?.sections != null and !jobTicket.answers.sections.empty}"
>
  <div
          th:each="section : ${jobTicket.answers.sections}"
          class="section-card"
  >
    <!-- Section Header -->
    <div class="section-header">
      <div>
        <!-- Section Title -->
        <h4 th:if="${section?.title != null}" th:text="${section.title}">
          No Title
        </h4>

        <!-- Section Description -->
        <p
                th:if="${section?.description != null and section.description.length() > 0}"
                class="section-description text-muted"
                th:text="${section.description}"
        ></p>
      </div>
    </div>

    <!-- Section Body -->
    <div class="section-body">
      <table style="width: 100%; border-collapse: collapse">
        <tbody>
        <tr
                th:each="question : ${section.questions}"
                style="border-bottom: 1px solid #eee"
        >
          <!-- Question Title -->
          <td style="padding: 10px; vertical-align: top; width: 40%">
            <div class="question-title" th:text="${question.title}">
              Question text
            </div>
            <div th:if="${question.hint != null and question.hint != ''}" class="question-hint text-muted small mt-1">
              <span style="display: inline-block; background-color: #0d6efd; color: white; width: 16px; height: 16px; border-radius: 50%; text-align: center; line-height: 16px; font-size: 12px; margin-right: 6px; font-style: normal;">i</span>
              <span th:text="${question.hint}" style="vertical-align: middle;"></span>
            </div>
          </td>
          <td style="padding: 10px; vertical-align: top; width: 60%">
            <!-- Text/Number/Date Response -->
            <div
                    th:if="${question.type == 'text' or question.type == 'number' or question.type == 'date'}"
                    class="response-content"
            >
              <div th:if="${question.response != null}">
                <div
                        th:if="${question.format == 'paragraph'}"
                        style="white-space: pre-line"
                        th:text="${question.response}"
                ></div>
                <span
                        th:if="${question.format != 'paragraph'}"
                        th:text="${question.response}"
                ></span>
                <div
                        th:if="${question.format != null and question.format != 'paragraph'}"
                        class="text-muted small"
                        style="margin-top: 4px"
                >
                  <em>Format: </em
                  ><span th:text="${question.format}"></span>
                </div>
              </div>
              <div
                      th:if="${question.response == null or question.response == ''}"
                      class="text-muted"
              >
                      <span
                              th:if="${question.defaultValue != null and question.defaultValue != ''}"
                              th:text="'Default: ' + ${question.defaultValue}"
                      ></span>
                <span
                        th:if="${question.defaultValue == null or question.defaultValue == ''}"
                >No response</span
                >
              </div>
            </div>

            <!-- Multiple Choice Response -->
            <div
                    th:if="${question.type == 'multiple_choice' or question.type == 'choice' or question.type == 'checkbox' or question.type == 'multiple-choice'}"
                    class="response-content"
            >
              <div th:if="${question.response != null and !#strings.isEmpty(question.response.toString())}">
                <!-- Handle array responses -->
                <div th:if="${#lists.size(question.response) > 0 or #arrays.length(question.response) > 0}">
                  <div
                          th:each="resp : ${#lists.size(question.response) > 0 ? question.response : #arrays.asList(question.response)}"
                          class="selected-choice"
                          style="display: inline-block; margin: 2px; padding: 2px 6px;"
                  >
                    <span th:text="${resp}"></span>
                    <span style="display: inline-block; width: 16px; height: 16px; background: #27ae60; border-radius: 2px; margin-left: 4px; position: relative;">
                            <span style="position: absolute; top: 1px; left: 5px; width: 5px; height: 9px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);"></span>
                          </span>
                  </div>
                </div>

                <!-- Handle single string response -->
                <div th:if="${(question.response != null) and (question.response.getClass().getSimpleName() == 'String') and (question.response != '')}"
                     class="selected-choice"
                     style="display: inline-block; margin: 2px; padding: 2px 6px;">
                  <span th:text="${question.response}"></span>
                </div>
              </div>

              <!-- No selection case -->
              <span th:if="${question.response == null or #strings.isEmpty(question.response.toString()) or
                                 (#lists.size(question.response) == 0 and #arrays.length(question.response) == 0)}"
                    class="text-muted">
                      No selection
                    </span>
            </div>

            <!-- Signature Response (simplified) -->
            <div
                    th:if="${question != null and question.type != null and question.type.toString() == 'signature'}"
                    class="signature"
            >
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <div>
                    <strong
                            th:text="${question.response?.name != null ? question.response.name : 'Not signed'}"
                    ></strong>
                  </div>
                  <div
                          th:if="${question.response?.role}"
                          class="text-muted small"
                          th:text="${question.response.role}"
                  ></div>
                  <div th:if="${question.response?.file}" class="mt-2">
                    <img
                            th:with="fileData=${question.response.file.startsWith('data:') ? question.response.file : 'data:image/png;base64,' + question.response.file}"
                            th:src="${fileData}"
                            alt="Signature"
                            style="
                              max-width: 200px;
                              max-height: 100px;
                              border: 1px solid #ddd;
                              background: white;
                              padding: 5px;
                            "
                    />
                  </div>
                  <span
                          th:if="${question.signatureDate != null}"
                          class="text-muted small d-block"
                  >
                          <span
                                  th:text="'Signed on ' + ${#temporals.format(question.signatureDate, 'yyyy-MM-dd HH:mm')}"
                          ></span>
                          <span
                                  th:if="${question.signatureAuto != null and question.signatureAuto}"
                                  class="badge bg-info ms-2"
                          >Auto-signed</span
                          >
                        </span>
                </div>
              </div>
            </div>

            <!-- File Response -->
            <div
                    th:if="${question != null and question.type != null and question.type.toString() == 'file' and question.response != null and (question.response.getClass().isArray() or question.response instanceof java.util.List)}"
                    class="file-response"
            >
              <div class="d-flex align-items-center">
                <i class="bi bi-paperclip me-2"></i>
                <span
                        th:if="${question.response.getClass().isArray() or question.response instanceof java.util.List}">
                        <span th:each="file, stat : ${question.response}">
                          <a
                                  th:if="${file.url != null}"
                                  th:href="${file.url}"
                                  th:text="${file.name != null ? file.name : 'File ' + (stat.index + 1)}"
                                  target="_blank"
                                  class="me-2"
                          ></a>
                          <span
                                  th:if="${file.size != null}"
                                  class="text-muted me-3"
                                  th:text="'(' + ${file.size} + ' KB)'"
                          ></span>
                        </span>
                      </span>
                <span
                        th:if="${!question.response.getClass().isArray() and !(question.response instanceof java.util.List)}"
                >
                        <a
                                th:if="${question.response.url != null}"
                                th:href="${question.response.url}"
                                th:text="${question.response.name != null ? question.response.name : 'Download File'}"
                                target="_blank"
                                class="me-2"
                        ></a>
                        <span
                                th:if="${question.response.size != null}"
                                class="text-muted"
                                th:text="'(' + ${question.response.size} + ' KB)'"
                        ></span>
                      </span>
              </div>
            </div>

            <!-- Comment -->
            <div
                    th:if="${question.comment and question.commentContent != null and !#strings.isEmpty(question.commentContent)}"
                    class="comment-box mt-2"
            >
              <div class="fw-bold">Comment:</div>
              <div th:utext="${question.commentContent}">
                Comment text goes here
              </div>
            </div>

            <!-- Attachments -->
            <div 
                 th:if="${question.attachmentContents != null and not #lists.isEmpty(question.attachmentContents)}" 
                 class="mt-3">
                <div class="fw-bold mb-1">Attachment:</div>
                <div class="d-flex flex-wrap gap-3">
                    <div th:each="attachment : ${question.attachmentContents}" class="mb-2">
                        <img th:src="${attachment}" 
                             style="max-width: 400px; max-height: 400px; display: block;"
                             alt="Question Attachment" class="img-fluid" />
                    </div>
                </div>
            </div>

            <!-- Question Metadata -->
            <div
                    class="question-metadata mt-2"
                    th:if="${question.metadata != null and not question.metadata.isEmpty()}"
            >
              <div class="d-flex flex-wrap gap-2">
                <div
                        th:each="entry : ${question.metadata.entrySet()}"
                        th:if="${entry != null and entry.value != null and entry.value != ''}"
                        class="badge bg-light text-dark border"
                >
                  <strong
                          th:if="${entry.key != null}"
                          th:text="${entry.key} + ':'"
                          class="me-1"
                  ></strong>
                  <span th:text="${entry.value}"></span>
                </div>
              </div>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Signatures Section -->
<div
        class="ticket-info"
        th:if="${jobTicket.contract?.signatures != null and !jobTicket.contract.signatures.empty}"
>
  <h3 class="mb-3">Signatures</h3>
  <div class="row">
    <div
            th:each="signature : ${jobTicket.contract.signatures}"
            class="col-md-6 mb-4"
    >
      <div class="signature h-100">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <h5 class="mb-1" th:text="${signature.name}">Signer Name</h5>
            <div
                    class="text-muted small"
                    th:if="${signature.role}"
                    th:text="${signature.role}"
            >
              Role
            </div>
            <div
                    class="text-muted small"
                    th:if="${signature.email}"
                    th:text="${signature.email}"
            >
              email@example.com
            </div>
            <div class="text-muted small" th:if="${signature.ipAddress}">
              IP: <span th:text="${signature.ipAddress}">IP Address</span>
            </div>
            <div th:if="${signature.status}" class="mt-2">
                  <span
                          class="badge"
                          th:classappend="${'bg-' + (signature.status == 'SIGNED' ? 'success' : 'warning')}"
                          th:text="${signature.status}"
                  >
                    Status
                  </span>
            </div>
          </div>
          <div
                  class="ms-3 signature-image-container"
                  th:if="${signature.signatureImage}"
          >
            <img
                    th:src="${'data:image/png;base64,' + signature.signatureImage}"
                    alt="Signature"
                    class="signature-image"
                    onerror="this.onerror=null; this.style.display='none';"
                    style="
                    max-width: 150px;
                    max-height: 100px;
                    border: 1px solid #ddd;
                    background: white;
                    padding: 5px;
                  "
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page Numbers Footer (empty, styled via CSS in head) -->
<div class="footer"></div>

<!-- Images Section -->
<div th:if="${not #lists.isEmpty(images)}" class="images-section" style="page-break-before: always;">
  <!-- First image on the same page as the header -->
  <div style="min-height: 100vh; display: flex; flex-direction: column; padding: 20px 0;">
    <div style="margin: 0 20px 30px 20px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef;">
      <h5 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #2c3e50;">Attachments</h5>
    </div>
    <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
      <div class="image-container" style="max-width: 100%; text-align: center;">
        <div class="image-wrapper" style="margin: 0 auto; max-width: 90%;">
          <img th:if="${images[0] != null and images[0] != ''}"
               th:src="${images[0]}" 
               alt="Image 1" 
               style="max-width: 100%; max-height: 80vh; height: auto; 
                      display: block; margin: 20px auto; object-fit: contain;" />
                      
          <div th:if="${images[0] == null or images[0] == ''}" 
               style="background: #f8f9fa; border: 1px dashed #ddd; padding: 40px; 
                      margin: 20px auto; text-align: center; color: #6c757d; border-radius: 4px;">
            [Image not available]
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Remaining images, each on a new page -->
  <div th:if="${#lists.size(images) > 1}">
    <div th:each="image, iter : ${images}" 
         th:if="${iter.index > 0}"
         style="page-break-before: always; break-before: page; min-height: 100vh; 
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                padding: 20px; box-sizing: border-box;">
    
    <div class="image-container" style="max-width: 100%; text-align: center;">
      <div class="image-wrapper" style="margin: 0 auto; max-width: 90%;">
        <img th:if="${image != null and image != ''}"
             th:src="${image}" 
             th:alt="'Image ' + (${iter.index} + 2)" 
             style="max-width: 100%; max-height: 90vh; height: auto; 
                    display: block; margin: 0 auto; object-fit: contain;" />
                    
        <div th:if="${image == null or image == ''}" 
             style="background: #f8f9fa; border: 1px dashed #ddd; padding: 40px; 
                    text-align: center; color: #6c757d; border-radius: 4px;">
          [Image not available]
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- JavaScript for interactive elements -->
<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // Toggle section visibility
    if (document.querySelectorAll(".section-toggle").length > 0) {
      document
        .querySelectorAll(".section-toggle")
        .forEach(function (toggle) {
          toggle.addEventListener("click", function () {
            const section = this.closest(".section-card");
            if (section) {
              const body = section.querySelector(".section-body");
              if (body) {
                const isCollapsed = body.classList.toggle("d-none");
                const span = this.querySelector("span");
                if (span) {
                  span.textContent = isCollapsed ? "Show" : "Hide";
                }
              }
            }
          });
        });
    }
  });
</script>


<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
