<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${jobTicket.answers?.title != null} ? ${jobTicket.answers.title} : 'Job Ticket Report'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-gray: #f8f9fa;
            --dark-gray: #6c757d;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--light-gray);
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        
        .ticket-info {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .section-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            page-break-inside: avoid;
            border: 1px solid var(--border-color);
        }
        
        .section-header {
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem 1.5rem;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header .icon {
            margin-right: 0.5rem;
        }
        
        .section-description {
            background-color: #ecf0f1;
            padding: 0.75rem 1.5rem;
            font-style: italic;
            color: #555;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-body {
            padding: 1.5rem;
        }
        
        .question {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #fff;
        }
        
        .question:last-child {
            margin-bottom: 0;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .question-text {
            font-weight: 500;
            margin: 0;
            color: var(--primary-color);
            flex: 1;
        }
        
        .question-type {
            font-size: 0.8em;
            color: var(--dark-gray);
            background-color: #e9ecef;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }
        
        .mandatory {
            color: var(--accent-color);
            font-weight: bold;
            margin-left: 0.5rem;
        }
        
        .response {
            color: #555;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background-color: var(--light-gray);
            border-left: 3px solid var(--secondary-color);
            border-radius: 4px;
        }
        
        .signature {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .signature-image {
            max-width: 250px;
            max-height: 100px;
            margin-top: 0.5rem;
            border: 1px solid var(--border-color);
            padding: 0.25rem;
            background-color: white;
        }
        
        .choice {
            display: inline-block;
            margin: 0.2rem 0.5rem 0.2rem 0;
            padding: 0.3rem 0.8rem;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 15px;
            font-size: 0.85em;
        }
        
        .selected-choice {
            background-color: #27ae60;
            font-weight: 500;
        }
        
        .comment-box {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .metadata {
            font-size: 0.85em;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .info-item {
            padding: 1rem;
            background-color: var(--light-gray);
            border-radius: 6px;
            border-left: 3px solid var(--secondary-color);
        }
        
        .info-label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3rem;
        }
        
        .info-value {
            color: #555;
            word-break: break-word;
        }
        
        .footer {
            text-align: center;
            padding: 1.5rem 0;
            color: var(--dark-gray);
            font-size: 0.85em;
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
        
        .validation-message {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .question-metadata {
            font-size: 0.8em;
            color: var(--dark-gray);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #dee2e6;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white;
                padding: 0;
                font-size: 12px;
            }
            
            .container {
                max-width: 100%;
                padding: 0 15px;
            }
            
            .section-card {
                box-shadow: none;
                border: 1px solid var(--border-color);
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .header {
                padding: 1rem 0;
                margin-bottom: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .ticket-info {
                padding: 1rem;
                margin-bottom: 1rem;
            }
        }
        
        /* Print-specific styles */
        @page {
            size: A4;
            margin: 1.5cm;
        }
    </style>
</head>
<body>
<div class="text-center mb-3">
    <img th:if="${logoUrl}" th:src="${logoUrl}" alt="Company Logo" class="img-fluid" style="max-height: 80px;" />
</div>
<div class="header" style="background-color: #3498db !important; color: white !important; padding: 1.5rem 0; margin-bottom: 2rem;">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h1 style="color: white !important;" th:if="${jobTicket.answers?.title != null}" th:text="${jobTicket.answers.title}">Job Ticket Report</h1>
                    <h1 style="color: white !important;" th:unless="${jobTicket.answers?.title != null}">Job Ticket Report</h1>
                    <p class="mb-0" style="color: #e0e0e0 !important;" th:if="${jobTicket.answers?.description != null}" th:text="${jobTicket.answers.description}"></p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="metadata">
                        <div><strong>Ticket ID:</strong> <span th:text="${jobTicket.id}">N/A</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="ticket-header mb-4">
            <div class="row">
                <!-- Equipment -->
                <div class="col-md-6 mb-3">
                    <div class="info-box">
                        <h5>Equipment</h5>
                        <div class="d-flex flex-column">
                            <div class="mb-2" th:if="${jobTicket.answers?.metadata?.additional?.asset?.designation}">
                                <strong>Designation:</strong>
                                <span th:text="${jobTicket.answers.metadata.additional.asset.designation}"></span>
                            </div>
                            <div th:if="${jobTicket.answers?.metadata?.additional?.asset?.partNumber != null and jobTicket.answers.metadata.additional.asset.partNumber != ''}" class="mb-2">
                                <strong>Part Number:</strong>
                                <span th:text="${jobTicket.answers.metadata.additional.asset.partNumber}"></span>
                            </div>
                            <div th:if="${jobTicket.answers?.metadata?.additional?.asset?.serialNumber != null and jobTicket.answers.metadata.additional.asset.serialNumber != ''}" class="mb-2">
                                <strong>Serial Number:</strong>
                                <span th:text="${jobTicket.answers.metadata.additional.asset.serialNumber}"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Info -->
                <div class="col-md-6 mb-3">
                    <div class="info-box">
                        <h5>Report Information</h5>
                        <div class="d-flex flex-column">
                            <div class="mb-2" th:if="${jobTicket.createdAt}">
                                <strong>Date and Time:</strong>
                                <span th:text="${#temporals.format(jobTicket.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                            </div>
                            <div th:if="${jobTicket.user?.email}">
                                <strong>Author:</strong> 
                                <span class="text-muted" th:text="'(' + ${jobTicket.user.email} + ')'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Sections -->
        <div th:if="${jobTicket.answers?.sections != null and !jobTicket.answers.sections.empty}">
            <div th:each="section : ${jobTicket.answers.sections}" class="section-card">
                <!-- Section Header -->
                <div class="section-header">
                    <div>
                        <h4 th:text="${section.title}">Section Title</h4>
                    </div>
                </div>
                
                <!-- Section Body -->
                <div class="section-body">
                    <div th:each="question : ${section.questions}" class="question">
                        <!-- Question Header -->
                        <div class="question-header">
                            <div class="question-text">
                                <span th:text="${question.title}">Question text</span>
                                <span th:if="${question.mandatory}" class="mandatory" title="Required">*</span>
                                <span class="question-type" th:text="${question.type}">type</span>
                            </div>
                            <div class="question-actions" th:if="${question.attachment or question.comment}">
                                <span th:if="${question.attachment}" class="badge bg-info me-1">Attachment</span>
                                <span th:if="${question.comment}" class="badge bg-warning">Comment</span>
                            </div>
                        </div>
                        
                        <!-- Question Hint -->
                        <div class="text-muted small mb-2" th:if="${question.hint}" th:text="${question.hint}">
                            Hint text goes here
                        </div>
                        
                        <!-- Question Response -->
                        <div class="response">
                            <!-- Text/Number/Date Response -->
                            <div th:if="${question.type == 'text' or question.type == 'number' or question.type == 'date'}" class="response-content">
                                <div th:if="${question.response != null}">
                                    <div th:if="${question.format == 'paragraph'}" class="mt-2" style="white-space: pre-line;" th:text="${question.response}"></div>
                                    <span th:if="${question.format != 'paragraph'}" th:text="${question.response}"></span>
                                    <div th:if="${question.format != null and question.format != 'paragraph'}" class="text-muted small mt-1">
                                        <em>Format: </em><span th:text="${question.format}"></span>
                                    </div>
                                </div>
                                <div th:if="${question.response == null}" class="text-muted">
                                    <span th:if="${question.defaultValue != null and question.defaultValue != ''}" 
                                          th:text="'Default: ' + ${question.defaultValue}"></span>
                                    <span th:if="${question.defaultValue == null or question.defaultValue == ''}">No response</span>
                                </div>
                            </div>
                            
                            <!-- Multiple Choice Response -->
                            <div th:if="${question.type == 'multiple_choice' or question.type == 'choice' or question.type == 'checkbox'}" class="response-content">
                                <div th:if="${question.response != null}">
                                    <span th:each="choice : ${question.choices}" 
                                          th:class="'choice' + (question.multipleAnswer ? 
                                            (question.response.contains(choice) ? ' selected-choice' : '') : 
                                            (question.response == choice ? ' selected-choice' : ''))"
                                          class="choice">
                                        <span th:text="${choice}"></span>
                                        <span th:if="${question.multipleAnswer and question.response.contains(choice)}" class="ms-1">âœ“</span>
                                    </span>
                                </div>
                                <span th:if="${question.response == null}" class="text-muted">No selection</span>
                                <div th:if="${question.multipleAnswer}" class="small text-muted mt-1">
                                    <em>Multiple selections allowed</em>
                                </div>
                            </div>
                            
                            <!-- Signature Response -->
                            <div th:with="hasSignature=${question != null and question.type != null and question.type.equals('signature')}" 
                                 th:if="${hasSignature}" class="signature">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span th:if="${question.signatureAuto}" class="badge bg-info me-2">Auto-signed</span>
                                        <span th:if="${question.signatureDate}" class="text-muted" 
                                              th:text="'Signed on ' + ${#temporals.format(question.signatureDate, 'yyyy-MM-dd HH:mm')}">
                                        </span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div>Signed by: <strong th:text="${question.response?.name ?: 'N/A'}">Name</strong></div>
                                        <div th:if="${question.response?.role}">Role: <span th:text="${question.response.role}"></span></div>
                                        <div th:if="${question.response?.email}" class="text-muted small" th:text="${question.response.email}"></div>
                                    </div>
                                    <div th:if="${question.response?.signatureImage}" class="ms-auto">
                                        <img th:src="${'data:image/png;base64,' + question.response.signatureImage}" 
                                             alt="Signature" class="signature-image" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File Attachment -->
                            <div th:if="${question.type == 'file' and question.response}" class="mt-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-paperclip me-2"></i>
                                    <a th:href="${question.response.url}" 
                                       th:text="${question.response.name}" 
                                       target="_blank">
                                        File Attachment
                                    </a>
                                    <span class="text-muted ms-2" th:text="'(' + ${question.response.size} + ' KB)'"></span>
                                </div>
                            </div>
                            
                            <!-- Comment -->
                            <div th:if="${question.comment and question.commentContent != null and !#strings.isEmpty(question.commentContent)}" class="comment-box mt-2">
                                <div class="fw-bold">Comment:</div>
                                <div th:utext="${question.commentContent}">Comment text goes here</div>
                            </div>
                            
                            <!-- Question Metadata -->
                            <div class="question-metadata mt-2" th:if="${question.metadata != null and not question.metadata.isEmpty()}">
                                <div class="d-flex flex-wrap gap-2">
                                    <div th:each="entry : ${question.metadata.entrySet()}" 
                                         th:if="${entry != null and entry.value != null and entry.value != ''}"
                                         class="badge bg-light text-dark border">
                                        <strong th:if="${entry.key != null}" th:text="${entry.key} + ':'" class="me-1"></strong>
                                        <span th:text="${entry.value}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Signatures Section -->
        <div class="ticket-info" th:if="${jobTicket.contract?.signatures != null and !jobTicket.contract.signatures.empty}">
            <h3 class="mb-3">Signatures</h3>
            <div class="row">
                <div th:each="signature : ${jobTicket.contract.signatures}" class="col-md-6 mb-4">
                    <div class="signature h-100">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h5 class="mb-1" th:text="${signature.name}">Signer Name</h5>
                                <div class="text-muted small" th:if="${signature.role}" th:text="${signature.role}">Role</div>
                                <div class="text-muted small" th:if="${signature.email}" th:text="${signature.email}">email@example.com</div>
                                <div class="text-muted small" th:if="${signature.signedAt}">
                                    Signed on <span th:text="${#temporals.format(signature.signedAt, 'yyyy-MM-dd HH:mm')}">Date</span>
                                </div>
                                <div class="text-muted small" th:if="${signature.ipAddress}">
                                    IP: <span th:text="${signature.ipAddress}">IP Address</span>
                                </div>
                                <div th:if="${signature.status}" class="mt-2">
                                    <span class="badge" 
                                          th:classappend="${'bg-' + (signature.status == 'SIGNED' ? 'success' : 'warning')}"
                                          th:text="${signature.status}">
                                        Status
                                    </span>
                                </div>
                            </div>
                            <div class="ms-3" th:if="${signature.signatureImage}">
                                <img th:src="${'data:image/png;base64,' + signature.signatureImage}" 
                                     alt="Signature" class="signature-image" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Document Footer -->
        <div class="footer">
            <div th:if="${jobTicket.answers?.footer}" th:utext="${jobTicket.answers.footer}" class="mb-2">
                <!-- Footer content from answers.footer -->
            </div>
            <div class="text-muted">
                Generated on <span th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm')}"></span>
            </div>
        </div>

        <!-- JavaScript for interactive elements -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                // Toggle section visibility
                if (document.querySelectorAll('.section-toggle').length > 0) {
                    document.querySelectorAll('.section-toggle').forEach(function(toggle) {
                        toggle.addEventListener('click', function() {
                            const section = this.closest('.section-card');
                            if (section) {
                                const body = section.querySelector('.section-body');
                                if (body) {
                                    const isCollapsed = body.classList.toggle('d-none');
                                    const span = this.querySelector('span');
                                    if (span) {
                                        span.textContent = isCollapsed ? 'Show' : 'Hide';
                                    }
                                }
                            }
                        });
                    });
                }
                
                // Print button functionality
                const printButton = document.getElementById('print-button');
                if (printButton) {
                    printButton.addEventListener('click', function() {
                        window.print();
                    });
                }
            });
        </script>
        
        <!-- Print Button -->
        <div class="text-center mb-4 no-print">
            <button id="print-button" class="btn btn-primary">
                <i class="bi bi-printer me-2"></i>Print Report
            </button>
        </div>
        
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
        
        <!-- Bootstrap JS Bundle with Popper -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>